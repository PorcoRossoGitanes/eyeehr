<!--
◆ペン色を追加する場合、各ボタンのdata-color属性を変更する。(RGB可)
◆ハッチング色を追加する場合、各ボタンのdata-color属性を変更し、
　imgフォルダ直下のbg-(data-color).svgを作成する。

フォルダ構成）
+svg_edit.html（本HTML)
+img/
  +bg-xxx.svg(ハッチング画像)
-->
<html>
	<head>
	    <meta content="text/html" charset="UTF-8">
    	<script src="js/jquery-2.1.1.js"></script>
		<script type="text/javascript" src="js/raphael-min.js"></script>
	</head>
	<body>
		<ul>
			<li><u>フリーハンド（太さ変更）</u></li>
			<li><u>ハッチング</u></li>
			<li>背景</li>
			<li>削除（ダブルクリックで削除できます）</li>
		</ul>
		<!-- TODO : 色が追加される場合、UI追加する。 -->
		<input class="tool pen"   type="button" data-color="black" value="→" title="黒ペン" style="color:black" />
		<input class="tool pen"   type="button" data-color="red" value="→" title="赤ペン" style="color:red" />
		<input class="tool pen"   type="button" data-color="blue"value="→" title="青ペン" style="color:blue" />
		<input class="tool pen"   type="button" data-color="green" value="→" title="緑ペン" style="color:green" />
		<input class="tool pen"   type="button" data-color="brown" value="→" title="茶ペン" style="color:brown" />
		<input class="tool pen"   type="button" data-color="yellow" value="→" title="黄ペン" style="color:yellow"/>
		ペン幅
		<select name="pen-width"> 
			<option value="1">1</option>
			<option value="3">3</option>
			<option value="5">5</option>
			<option value="7">7</option>
			<option value="9">9</option>
		</select>

		<input class="tool hatch" type="button" data-color="black" value="///" title="黒ハッチ" style="color:black" />
		<input class="tool hatch" type="button" data-color="red" value="///" title="赤ハッチ" style="color:red" />
		<input class="tool hatch" type="button" data-color="blue" value="///" title="青ハッチ" style="color:blue" />
		<input class="tool hatch" type="button" data-color="green" value="///" title="緑ハッチ" style="color:green" />
		<input class="tool hatch" type="button" data-color="brown" value="///" title="茶ハッチ" style="color:brown" />
		<input class="tool hatch" type="button" data-color="yellow" value="///" title="黄ハッチ" style="color:yellow" />
		<input class="tool" type="file" value="画像挿入"/>
		<!--SVGキャンバス部-->
		<div id="svg"></div>
		<script type="text/javascript">
$(function(){
    // SVGキャンバスを設定する。（幅・高さ・背景色）
    var stageW = 590, stageH = 300, bgcolor = "#eee";
    $('#svg').css('width', stageW);
    $('#svg').css('height', stageH);
    $('#svg').css('background', bgcolor);

    // キャンバスにペーパーを用意する。
    var paper = Raphael("svg", $('#svg').css('width'), $('#svg').css('height'));

//------------------------------
	// @param 現在のツール
	var currentTool = TOOL_PEN; 
	const TOOL_PEN = 'PEN';
	const TOOL_HATCH = 'HATCH';

	// @param 現在のペン色
	var currentPenColor = 'black';
	// @param 現在のペン幅
	var currentPenWitdh = 1;

	// @param 現在のハッチ色
	var currentHatchColor = 'black';

	// ツールを切り替える。
	$('.tool.pen').click(function(){
		// ツールをペンに変更する。
		currentTool = TOOL_PEN;
		// ペン色を変更する。
		currentPenColor = $(this).data('color');
	});
	$('.tool.hatch').click(function(){
		// ツールをハッチに変更する。
		currentTool = TOOL_HATCH;
		currentHatchColor = $(this).data('color');
	});
	// @event ペン幅変更
	$('[name=pen-width]').change(function(){
		currentPenWitdh = $(this).val();
	});


//------------------------------
	// @param マウスのクリック状態（クリック時、true）
    var clicked = false;

	// @param パス（フリーハンド）のインスタンス　→　ペン・ハッチング用
   	var path = undefined;

    // @param パスの座標データ（格納用）
    var d = "";
    
    // @param 直前の座標(prevX,prevY) 現在の座標(x,y)
   	var prevX = undefined, prevY = undefined, x = undefined, y = undefined;

   	// @event マウスダウン時、描画を開始する。===
   	$('#svg').mousedown(function(e){ startDrawing(); });
    $('#svg').bind('touchstart', function(e){ startDrawing();});

    /// @summary 描画開始
   	function startDrawing () 
   	{
	   	prevX = undefined;
	   	prevY = undefined;
   		clicked = true;
   		d = "";   
   	}
   	//===

   	// @event マウスアップ時、描画を終了する。===
   	$('#svg').mouseup(function(e){ stopDrawing(); });
    $('#svg').bind('touchend', function(e){ stopDrawing();});

    /// @summary 描画停止
   	function stopDrawing ()
   	{
   		clicked = false;
   		path = undefined;
   	}
   	//===

   	// @event マウス移動時、描画を実行する。
    $('#svg').mousemove(function(e){
    	draw(e.offsetX, e.offsetY); 
 	});
    $('#svg').bind('touchmove', function(e){ 
    	// タッチ移動による画面移動を抑止する。
    	event.preventDefault();
    	// TODO : 画面を下に移動したときの動作をチェックする
    	draw(
    		event.changedTouches[0].pageX - $(this).position().left, 
    		event.changedTouches[0].pageY - $(this).position().top
    	); 
    });

    /// @summary パスを描画する。
    function draw (currentX, currentY) 
    {
    	// クリック中はフリーハンドでライン／ハッチングを描ける
    	if (clicked)
    	{
    		// 現在位置と直前の位置を取得する。
	    	x = currentX;
	    	y = currentY;
	    	prevX = prevX === undefined ? x : prevX; 
	    	prevY = prevY === undefined ? y : prevY;

	    	// PathStringを作成する。
    		d = (d == "") ? 
    			("M" + prevX + "," + prevY + " " + "L" + x + "," + y) : 
    			(d + " " + "L" + x + "," + y);

    		if (path === undefined)
    		{

	    		path =  paper.path(d);
	    		// ハッチングが必要な場合は、ハッチングを設定する。
	    		if (currentTool == TOOL_HATCH)
	    		{
		    		path.attr({ 'fill' : 'url(img/bg-' + currentHatchColor + '.svg)'});
	    		} 
	    		// ハッチングは枠線を表示しない。
	    		path.attr({ 'stroke-width': (currentTool == TOOL_HATCH) ? 1 : currentPenWitdh }); 
	    		path.attr({ 
	    			'stroke' : (currentTool == TOOL_HATCH) ? currentHatchColor : currentPenColor
	    		});
    		}
    		else 
    		{
    			path.attr('path', d);
    		}

    		// パスにダブルクリック時、パスを削除する。
    		path.dblclick(function (){
    			this.remove();
    		})

    		// path.drag(
    		// 	function(){console.log('移動')},
    		// 	function(){},
    		// 	function(){}
    		// );

    	}
    }

 //    var src = "data:image/jpeg;base64,/9j/4AAQSk...";
	// var img = paper.image(src, 10, 10, 80, 80);
	// img.drag = function(e)
	// {
	// 	console.log(e.clientX + ", "+ e.clientY);
	// 	//img.scale(1,2);
	// 	console.log(this)
	// };
	// paper.text(100, 199, "test");
	// var c = paper.circle(10, 10, 10);
	// console.log(c.node);
	// c.node.onclick = function () {
	//     c.attr("fill", "red");
	// };


});
//------------------------------
		</script>
		<script type="text/javascript">

		</script>

		<!-- Data Schemeを出力する。 -->
		<button id="DATA_SCHEME">Data Schemeで出力</button>
		<!-- SVGタグを出力する。 -->
		<button id="SVG_SRC">SVGタグ出力</button>
		<script>
$('#SVG_SRC').click(function(){
	var svg_xml = $('div#svg').html();

	$('textarea#SVG_XML').text(svg_xml);
	var b64 = Base64.encode(svg_xml); 
	var url = "data:image/svg+xml;base64," + b64;
	var img = "<img src='"+ url +"' alt='file.svg'/>";
	$('textarea#SVG_DSCHEME').text(url);
	$('div#SVG_DSCHEME').html(img);
	$('div#SVG_XML').html(svg_xml);
});
		</script>
		<textarea id="SVG_DSCHEME"></textarea>
		<textarea id="SVG_XML"></textarea>
		<div id="SVG_DSCHEME"></div>
		<div id="SVG_XML" ></div>

		<!--そのままSVGタグを取得すれば、画像は抽出できる-->
		<!--svg height="300" version="1.1" width="590" xmlns="http://www.w3.org/2000/svg" style="overflow: hidden; position: relative;"><desc>Created with Raphaﾃｫl 2.1.2</desc><defs></defs><circle cx="150" cy="100" r="50" fill="none" stroke="#000"></circle></svg-->
	</body>
</html>